---
- name: Full Docker CI + Push to AWS ECR
  hosts: docker_hosts
  become: yes
  vars_files:
    - ../../vault.yml   # path to your encrypted vault file

  vars:
    aws_region: "ap-south-1"
    aws_account_id: "725889403091"        # Your AWS Account ID
    ecr_repo: "kishor2107-ecrrepo-mumbai"
    local_image_name: "kishor-nginx"
    local_image_tag: "v1"
    docker_app_dir: "/home/ubuntu/docker-app"

  tasks:

    #############################
    # 1️⃣ Install Docker
    #############################
    - name: Remove old Docker packages (if any)
      apt:
        name:
          - docker
          - docker-engine
          - docker.io
          - containerd
          - runc
        state: absent
        purge: yes

    - name: Install prerequisite packages
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add Docker’s official GPG key
      ansible.builtin.shell: |
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Set up Docker repository
      ansible.builtin.shell: |
        echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
        $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/docker.list

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install Docker Engine
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: latest

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    #############################
    # 2️⃣ Build Docker image
    #############################
    - name: Create app directory
      file:
        path: "{{ docker_app_dir }}"
        state: directory

    - name: Copy Docker app files
      copy:
        src: ../../docker/
        dest: "{{ docker_app_dir }}/"
        mode: 0755

    - name: Build Docker image
      community.docker.docker_image:
        name: "{{ local_image_name }}"
        tag: "{{ local_image_tag }}"
        source: build
        build:
          path: "{{ docker_app_dir }}"

    #############################
    # 3️⃣ Install AWS CLI
    #############################
    - name: Install unzip (required for AWS CLI)
      apt:
        name: unzip
        state: present

    - name: Download AWS CLI v2
      get_url:
        url: "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
        dest: "/tmp/awscliv2.zip"
        mode: '0644'

    - name: Unzip AWS CLI
      unarchive:
        src: "/tmp/awscliv2.zip"
        dest: "/tmp/"
        remote_src: yes

    - name: Install AWS CLI
      command: "/tmp/aws/install --update"
      args:
        creates: /usr/local/bin/aws

    #############################
    # 4️⃣ Configure AWS credentials
    #############################
    - name: Create AWS config directory
      file:
        path: /home/ubuntu/.aws
        state: directory
        mode: '0700'
        owner: ubuntu
        group: ubuntu

    - name: Configure AWS credentials
      copy:
        dest: /home/ubuntu/.aws/credentials
        content: |
          [default]
          aws_access_key_id = {{ aws_access_key_id }}
          aws_secret_access_key = {{ aws_secret_access_key }}
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    - name: Configure AWS config
      copy:
        dest: /home/ubuntu/.aws/config
        content: |
          [default]
          region = {{ aws_region }}
          output = json
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    #############################
    # 5️⃣ Login to ECR
    #############################
    - name: Login to AWS ECR
      shell: aws ecr get-login-password --region {{ aws_region }} | docker login --username AWS --password-stdin {{ aws_account_id }}.dkr.ecr.{{ aws_region }}.amazonaws.com
      args:
       executable: /bin/bash


    #############################
    # 6️⃣ Tag and push Docker image
    #############################
    - name: Tag Docker image for ECR
      command: >
        docker tag {{ local_image_name }}:{{ local_image_tag }}
        {{ aws_account_id }}.dkr.ecr.{{ aws_region }}.amazonaws.com/{{ ecr_repo }}:{{ local_image_tag }}

    - name: Push Docker image to ECR
      command: >
        docker push {{ aws_account_id }}.dkr.ecr.{{ aws_region }}.amazonaws.com/{{ ecr_repo }}:{{ local_image_tag }}

